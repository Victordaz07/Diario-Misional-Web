rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only access their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Missionary profiles
    match /missionaries/{missionaryId} {
      allow read, write: if request.auth != null && request.auth.uid == missionaryId;
      // Allow family members to read (if they have the family code)
      allow read: if request.auth != null && 
        resource.data.familyCode == request.auth.token.familyCode;
    }
    
    // Diary entries
    match /diary/{entryId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.missionaryId;
      // Allow family to read shared entries
      allow read: if request.auth != null && 
        resource.data.sharedWithFamily == true &&
        request.auth.token.familyCode == resource.data.familyCode;
    }
    
    // Photos
    match /photos/{photoId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.missionaryId;
      // Allow family to read shared photos
      allow read: if request.auth != null && 
        resource.data.sharedWithFamily == true &&
        request.auth.token.familyCode == resource.data.familyCode;
    }
    
    // Transfers
    match /transfers/{transferId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.missionaryId;
      // Allow family to read
      allow read: if request.auth != null && 
        request.auth.token.familyCode == resource.data.familyCode;
    }
    
    // Resources (public read, admin write)
    match /resources/{resourceId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.auth.token.admin == true;
    }
    
    // Family portal data
    match /family-portal/{familyId} {
      allow read, write: if request.auth != null && 
        request.auth.token.familyCode == familyId;
    }
  }
}
